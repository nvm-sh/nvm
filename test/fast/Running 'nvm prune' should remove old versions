#!/bin/sh

# Test: Running 'nvm prune' should remove old versions

die () { echo "$@" ; exit 1; }

# Mocking nvm_ls output logic relies on nvm_ls calling directory listing.
# Instead of mocking filesystem which is complex, we will override nvm_ls and nvm_ls_current.

. ../../nvm.sh

# Mock nvm_ls to return specific versions as if they were installed
# The implementation of nvm_prune calls: nvm_ls --no-colors --no-alias
# We must mock nvm_ls to respond to that or just return the list.
# Note: nvm_prune strips output except vX.Y.Z.
nvm_ls() {
  echo "       v16.20.2"
  echo "       v18.20.5"
  echo "       v18.20.7"
  echo "       v20.17.0"
  echo "->     v22.22.0"
  echo "       v24.13.0"
}

# Mock nvm_ls_current
nvm_ls_current() {
  echo "v22.22.0"
}

# Mock nvm function to intercept uninstall calls
# nvm_prune calls `nvm uninstall`.
UNINSTALLED_VERSIONS=""
nvm() {
  if [ "$1" = "uninstall" ]; then
    UNINSTALLED_VERSIONS="${UNINSTALLED_VERSIONS} $2"
    return 0
  fi
  echo "nvm called with unexpected args: $*"
}

# Run prune
nvm_prune

# Expected:
# v16.20.2 (Keep: Only one v16)
# v18.20.5 (Delete: v18.20.7 is newer) -> WAIT. v18.20.7 is newer. So keep 18.20.7. Delete 18.20.5.
# v18.20.7 (Keep: Latest v18)
# v20.17.0 (Keep: Only one v20)
# v22.22.0 (Keep: Current)
# v24.13.0 (Keep: Only one v24)

# Wait, my logic for nvm_prune was to keep latest per major.
# v18.20.5 and v18.20.7 are Major 18. 
# Latest is v18.20.7.
# So v18.20.5 should be pruned.

# Check UNINSTALLED_VERSIONS
EXPECTED=" v18.20.5"
if [ "${UNINSTALLED_VERSIONS}" != "${EXPECTED}" ]; then
  die "Expected uninstalled: '${EXPECTED}', got: '${UNINSTALLED_VERSIONS}'"
fi

# New Test Case: Current version is NOT the latest.
# v18.1.0 (Current)
# v18.2.0 (Latest)
# v18.0.0 (Old)

nvm_ls() {
  echo "       v18.0.0"
  echo "->     v18.1.0"
  echo "       v18.2.0"
}

nvm_ls_current() {
  echo "v18.1.0"
}

UNINSTALLED_VERSIONS=""
nvm_prune

# Expected:
# v18.0.0 (Prune)
# v18.1.0 (Keep: Current)
# v18.2.0 (Keep: Latest)

EXPECTED=" v18.0.0"

if [ "${UNINSTALLED_VERSIONS}" != "${EXPECTED}" ]; then
  die "TestCase 2 Failed. Expected uninstalled: '${EXPECTED}', got: '${UNINSTALLED_VERSIONS}'"
fi

echo "All tests passed"
