#!/bin/sh
# shellcheck shell=dash
# shellcheck disable=SC2039 # local is non-POSIX

cleanup () {
  unset -f die cleanup NVM_NODEJS_ORG_MIRROR
  docker stop ferron-nodejs-mirror && docker rm ferron-nodejs-mirror
  docker stop ferron-iojs-mirror && docker rm ferron-iojs-mirror
}
die () { echo "$@" ; cleanup ; exit 1; }

set -e

{ [ -e "ferron-nodejs-mirror.kdl" ] && [ -e "ferron-iojs-mirror.kdl" ]; } || die nvm_ls_remote_with_proxy_requiring_basic_auth Need to set working directory of script to Unit tests directory.

# shellcheck source=/dev/null # The nvm.sh script is checked separately.
\. ../../../nvm.sh

docker run --detach --name ferron-nodejs-mirror --publish 8080:8080 --volume "$(pwd):/mnt/cwd" ferronserver/ferron:2 ferron --config /mnt/cwd/ferron-nodejs-mirror.kdl
docker run --detach --name ferron-iojs-mirror --publish 8081:8081 --volume "$(pwd):/mnt/cwd" ferronserver/ferron:2 ferron --config /mnt/cwd/ferron-iojs-mirror.kdl
sleep 1 # wait for ferron containers to start

export NVM_NODEJS_ORG_MIRROR="http://localhost:8080/dist"
export NVM_IOJS_ORG_MIRROR="http://localhost:8081/dist"
# These credentials were generated by running `printf 'test:123?45>6' | base64`. These credentials were chosen because their
# base64 encoded value contain the necessary special characters '+', '/', and '='.
base64_encoded_credentials="dGVzdDoxMjM/NDU+Ng=="
export NVM_AUTH_HEADER="Basic ${base64_encoded_credentials}"

OUTPUT="$(nvm_ls_remote)"
echo "nvm_ls_remote output: ${OUTPUT}"
[ -n "${OUTPUT}" ] || die nvm_ls_remote_with_proxy_requiring_basic_auth Failed to run nvm_ls_remote through nodejs mirror requiring basic auth.

OUTPUT="$(nvm_ls_remote_iojs)"
echo "nvm_ls_remote_iojs output: ${OUTPUT}"
[ -n "${OUTPUT}" ] || die nvm_ls_remote_with_proxy_requiring_basic_auth Failed to run nvm_ls_remote_iojs through iojs mirror requiring basic auth.

# Remove auth header and try using mirrors. This time it should fail due to missing creds.
unset NVM_AUTH_HEADER

nvm_ls_remote && die nvm_ls_remote_with_proxy_requiring_basic_auth Unexpected success of run of nvm_ls_remote through nodejs mirror without required credentials.

nvm_ls_remote_iojs && die nvm_ls_remote_with_proxy_requiring_basic_auth Unexpected success of run of nvm_ls_remote_iojs through iojs mirror without required credentials.

cleanup
